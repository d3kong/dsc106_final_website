<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Surgical Insight Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <!-- BACK TO TITLE BUTTON -->
  <button id="back-btn">
    ← Back to Start
  </button>

  <!-- OVERLAY: Centered Body Map, appears at first -->
  <div id="center-overlay">
    <div id="center-body-map">
      <svg id="overlay-body-map" width="210" height="420" viewBox="0 0 210 420">
        <image href="images/body.png" x="0" y="0" width="210" height="420" opacity="0.9"/>
        <ellipse class="region" id="center_head_neck" cx="105" cy="65" rx="47" ry="47"/>
        <ellipse class="region" id="center_thorax" cx="105" cy="130" rx="45" ry="47"/>
        <ellipse class="region" id="center_abdomen" cx="105" cy="220" rx="53" ry="48"/>
        <ellipse class="region" id="center_pelvis" cx="104" cy="285" rx="50" ry="40"/>
      </svg>
      <div class="body-map-label" style="color:#fff;margin-top:2rem;font-size:1.13rem;">Click a region to start</div>
    </div>
  </div>

  <!-- MAIN DASHBOARD (hidden at first) -->
  <div id="main-app">
    <!-- LEFT: Body Outline for Region Filtering -->
    <div id="left-column">
      <div id="body-map-container">
        <svg id="body-map" viewBox="0 0 210 420">
          <image
            href="images/body.png"
            x="0" y="0"
            width="210" height="420"
            preserveAspectRatio="xMidYMid slice"
            opacity="0.9"
          />
          <ellipse class="region" id="center_head_neck" cx="105" cy="65" rx="47" ry="47"/>
          <ellipse class="region" id="center_thorax" cx="105" cy="130" rx="45" ry="47"/>
          <ellipse class="region" id="center_abdomen" cx="105" cy="220" rx="53" ry="48"/>
          <ellipse class="region" id="center_pelvis" cx="104" cy="285" rx="50" ry="40"/>
        </svg>
        <div class="body-map-label">Click on a region to filter operations</div>
      </div>
    </div>

    <!-- RIGHT: Chart Area -->
    <div id="right-column">

      <!-- Context Paragraph -->
      <p style="margin: 0;">
        In our 68-year-old ASA 4 patient’s case, a “low-risk” procedure can quickly become life-threatening.  
        This swarm plot lines up the same surgery at two risk levels and colors each dot by ASA score—so you can see exactly where the danger threshold hits.  
        As ASA rises, watch how points leap upward on the outcome axis, signaling when we must rethink timing, technique, or even candidacy for surgery.  
      </p>

      <!-- Viz 1: Swarm Chart Placeholder -->
      <section id="viz1" class="chart-section">
        <h3>Chart 1: Risk vs. ASA (Swarm Plot)</h3>
        <div
          id="swarm-container"
          style="width: 100%; height: 90vh; display: flex; align-items: center; justify-content: center; background: #4a4a4a;">
          <span style="color: #999;">[Swarm Chart will render here]</span>
        </div>
      </section>

      <!-- Interpretation Paragraph -->
      <p style="margin: 1rem 0;">
        Rather than blending a composite score, this heatmap zeroes in on one crucial outcome—mortality—and compares it for our selected low- and high-risk surgeries across every ASA category.  
        On the X-axis you’ll see the two procedures (low vs. high risk for the chosen region), and on the Y-axis each ASA level from 1 through 5.  
        Darker cells flag where past patients at that ASA score faced the highest mortality rates—revealing exactly how danger scales as systemic disease worsens.  
        For our ASA 4 focal patient, this makes it crystal-clear how much more life-threatening the high-risk option becomes—and where the line between “acceptable” and “too dangerous” lies.
      </p>

      <!-- Viz 2: Heatmap Placeholder -->
      <section id="viz2" class="chart-section">
        <div
          id="heatmap-container"
          style="width: 100%; height: 90vh; display: flex; align-items: center; justify-content: center; background: #4a4a4a;"
        >
          <span style="color: #999;">[Heatmap will render here]</span>
        </div>
      </section>

      <!-- Interpretation Paragraph -->
      <p style="margin: 1rem 0;">
        Now the surgeon must choose—and explain—what comes next.  
        This interactive radar chart adapts to our ASA 4 patient’s profile (ASA, comorbidities, BMI, etc.) and the selected surgery, plotting five communication priorities: 
        <em>Medical Complexity</em>, <em>Recovery Support Needs</em>, <em>Decision Clarity</em>, <em>Emotional Sensitivity</em>, and <em>Information Depth</em>.  
      </p>

      <!-- Viz 3: Radar Chart Placeholder -->
      <section id="viz3" class="chart-section">
        <div id="radar-container"
        style="background: #4a4a4a; padding: 2em;"></div>
      </section>   
      
    </div>
  </div>

  <!-- ───── DASHBOARD PAGE SCRIPTS ───── -->
  <script src="js/dashboard_main.js"></script>
  <script src="js/tracy_main.js"></script>
  <script src="js/daniel_main.js"></script>
  <script src="js/kate_main.js"></script>
  <script>
    // Overlay animation logic
    const regionMap = {
      center_head_neck: 'head_neck',
      center_thorax: 'thorax',
      center_abdomen: 'abdomen',
      center_pelvis: 'pelvis'
    };
    document.querySelectorAll('#overlay-body-map .region').forEach(region => {
      region.addEventListener('click', function() {
        const rId = regionMap[this.id];
        if (rId) {
          window.selectedRegion = rId;
          document.getElementById('center-overlay').classList.add('hide');
          setTimeout(() => {
            document.getElementById('center-overlay').style.display = 'none';
            document.getElementById('main-app').classList.add('show');
            // Set region as selected in left body map
            setTimeout(() => {
              d3.selectAll("#body-map .region").classed("region--selected", false);
              d3.select(`#body-map .region#${rId}`).classed("region--selected", true);
              window.dispatchEvent(new Event("regionChange"));
            }, 200);
          }, 700);
        }
      });
    });
    // Restart: hide dashboard, reveal overlay, clear regions
    document.getElementById('restart-btn').addEventListener('click', function() {
      window.selectedRegion = null;
      document.getElementById('main-app').classList.remove('show');
      setTimeout(() => {
        document.getElementById('center-overlay').style.display = 'flex';
        setTimeout(() => {
          document.getElementById('center-overlay').classList.remove('hide');
          d3.selectAll("#body-map .region").classed("region--selected", false);
          window.dispatchEvent(new Event("regionChange"));
        }, 60);
      }, 700);
    });
    // Tooltips for center body map
    function setupBodymapTooltip(svgSelector, idPrefix='') {
      let tooltip = d3.select("body").select(".bodymap-tooltip");
      if (tooltip.empty()) {
        tooltip = d3.select("body")
          .append("div")
          .attr("class", "bodymap-tooltip")
          .style("display", "none");
      }
      const tooltipData = {
        head_neck: {label: "Head/Neck", low: "Thyroid lobectomy", high: "Total thyroidectomy"},
        thorax: {label: "Thorax/Chest", low: "Breast-conserving surgery", high: "Lung lobectomy"},
        abdomen: {label: "Abdomen", low: "Cholecystectomy", high: "Exploratory laparotomy"},
        pelvis: {label: "Pelvis/Lower Abdomen", low: "Ileostomy repair", high: "Low anterior resection"}
      };
      d3.selectAll(svgSelector + " .region")
        .on("mouseover", function(event) {
          let reg = this.id.replace(idPrefix, '');
          let info = tooltipData[reg];
          if (info) {
            tooltip
              .style("display", "block")
              .html(`
                <strong>${info.label}</strong><br>
                <span style="color:#1a6;"><b>Low Risk:</b> ${info.low}</span><br>
                <span style="color:#b10;"><b>High Risk:</b> ${info.high}</span>
              `);
          }
        })
        .on("mousemove", function(event) {
          tooltip
            .style("left", (event.pageX + 16) + "px")
            .style("top", (event.pageY - 12) + "px");
        })
        .on("mouseout", function() {
          tooltip.style("display", "none");
        });
    }
    setupBodymapTooltip("#overlay-body-map", "center_");
    setupBodymapTooltip("#body-map", "");

    // Back-to-title button behavior
    document.getElementById('back-btn').addEventListener('click', () => {
      window.location.href = 'index.html?view=narrative';
    });
  </script>
</body>
</html>
